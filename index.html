<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ü–û–õ–ï –ß–£–î–ï–° ‚Äî –Æ–±–∏–ª–µ–π–Ω–æ–µ –∏–≥—Ä–∞</title>
  <style>
    :root{
      --ink:#f7f9ff; --muted:#b9c6ff;
      --gold:#ffdc73; --gold2:#ffcc33; --gold3:#b98a00; --blue:#0f1d47; --blue2:#0a1535; --card:#0b1f4a;
      --good:#4ee6a3; --bad:#ff7a7a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:url('unnamed.jpg') repeat fixed center/220px #06122b;
    }
    .veil{min-height:100%; backdrop-filter: blur(1px); background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.75));}
    .wrap{max-width:1180px; margin:0 auto; padding:24px}

    .title{font-size:34px; font-weight:900; letter-spacing:2px; text-transform:uppercase; color:var(--gold);
      text-shadow:0 2px 0 #000, 0 7px 18px rgba(0,0,0,.4)}
    .sub{color:var(--muted); font-size:13px}

    .grid{display:grid; grid-template-columns:1.2fr 0.9fr; gap:18px; margin-top:16px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.1); border-radius:20px; box-shadow:0 18px 60px rgba(0,0,0,.4)}
    .pad{padding:18px}
    .bar{display:flex; align-items:center; justify-content:space-between; gap:12px}
    .gold{color:var(--gold)}
    .btn{appearance:none; border:none; cursor:pointer; font-weight:900; letter-spacing:.3px; color:#1a1400; background:linear-gradient(180deg, var(--gold), var(--gold2)); border-radius:14px; padding:10px 14px; box-shadow:0 4px 0 var(--gold3), 0 10px 26px rgba(0,0,0,.3)}
    .btn:active{transform:translateY(1px)}
    .btn-ghost{background:linear-gradient(180deg,#142458,#0e1a44); color:var(--ink); border:1px solid rgba(255,255,255,.12)}

    .wheel-wrap{position:relative; display:grid; place-items:center; padding:26px; border-radius:24px; background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.1)}
    #wheel{width:100%; max-width:740px; aspect-ratio:1; background:#06112a; border-radius:50%; box-shadow:inset 0 0 50px rgba(0,0,0,.7)}
    .pin{position:absolute; top:10px; left:50%; transform:translateX(-50%);
         width:0; height:0; border-left:16px solid transparent; border-right:16px solid transparent;
         border-bottom:26px solid var(--gold2); filter:drop-shadow(0 3px 8px rgba(0,0,0,.6))}
    .cap{position:absolute; width:150px; height:150px; border-radius:50%; background:radial-gradient(circle at 35% 30%, #fff, #ffe9a3 40%, #ffcf4d 60%, #d2a500 100%); box-shadow: inset 0 0 30px rgba(0,0,0,.35), 0 6px 24px rgba(0,0,0,.5); display:grid; place-items:center}
    .cap .btn{border-radius:50%; padding:18px 18px}

    .panel{min-height:84px; display:flex; align-items:center; justify-content:space-between; gap:10px}
    .panel .rule{font-weight:800}
    .log{margin-top:10px; height:110px; overflow:auto; padding:8px 12px; background:#0c1130; border-radius:12px; border:1px solid rgba(255,255,255,.08)}

    .qbox{min-height:210px}
    .q{font-weight:800}
    .word-len{opacity:.8; font-size:13px}
    .answer{display:flex; gap:8px; margin-top:10px}
    .answer input{flex:1; padding:12px 14px; border-radius:12px; border:2px solid transparent; background:#0f1538; color:var(--ink); font-weight:700; letter-spacing:.5px}
    .answer.correct input{border-color:var(--good)}
    .answer.wrong input{border-color:var(--bad)}
    .note{font-size:12px; color:var(--muted)}

    /* Intro modal */
    .intro{position:fixed; inset:0; display:grid; place-items:center; background:rgba(7,10,24,.88); z-index:1000}
    .intro.hide{display:none}
    .ibox{width:min(720px,92vw); background:linear-gradient(180deg, #12265c, #0d1b46); border:1px solid rgba(255,255,255,.12); border-radius:20px; box-shadow:0 28px 90px rgba(0,0,0,.55); padding:18px}
    .ibox h3{margin:0; color:var(--gold); text-shadow:0 1px 0 #000}
    .itype{margin-top:10px; background:#0f1538; border:1px solid rgba(255,255,255,.1); border-radius:12px; padding:12px; min-height:120px; max-height:280px; overflow:auto; font-weight:700; line-height:1.35}
    .icta{display:flex; gap:10px; margin-top:12px}

    /* Q modal */
    .modal{position:fixed; inset:0; background:rgba(5,10,25,.86); display:none; place-items:center; z-index:1500}
    .modal.show{display:grid}
    .modal-card{width:min(720px,92vw); border-radius:20px; padding:22px; color:var(--ink);
      background:linear-gradient(180deg,#12265c,#0d1b46);
      border:1px solid rgba(255,255,255,.12); box-shadow:0 28px 90px rgba(0,0,0,.55); text-align:center}
    .modal-title{margin:0 0 8px; color:var(--gold); font-weight:900}
    .modal-text{font-weight:800; margin:6px 0 14px}
    .bigScore{font-weight:900; font-size:clamp(42px, 9vw, 120px); line-height:1; color:var(--gold);
      text-shadow:0 2px 0 #000,0 10px 26px rgba(0,0,0,.35)}

    .points{font-weight:900; color:var(--gold); text-shadow:0 0 12px rgba(255,220,115,.9)}
    canvas.confetti{position:fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:2000}

    /* Final gifts */
    .final{position:fixed; inset:0; background:rgba(0,0,0,.86); display:none; place-items:center; z-index:2200}
    .final.show{display:grid}
    .final-card{width:min(980px,94vw); background:linear-gradient(180deg,#112552,#0d1c45); color:var(--ink);
      border:1px solid rgba(255,255,255,.12); border-radius:20px; box-shadow:0 28px 90px rgba(0,0,0,.55); padding:18px}
    .final-title{margin:0; color:var(--gold); font-weight:900}
    .gift-grid{display:grid; gap:10px; margin-top:14px}
    .gift-row{display:grid; grid-template-columns:auto 1fr; gap:10px; align-items:center; background:#0b1636; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px}
    .gift-row a{color:var(--gold); text-decoration:underline; cursor:pointer}
    .final-bar{display:flex; gap:10px; justify-content:space-between; align-items:center; margin-top:12px; flex-wrap:wrap}
    .pill{background:#0e1a44; border:1px solid rgba(255,255,255,.15); border-radius:999px; padding:8px 12px; font-weight:800}
    .warn{color:#ff7a7a}

    /* Fullscreen video (mp4 + YouTube) */
    .vmodal{position:fixed; inset:0; background:rgba(0,0,0,.96); display:none; place-items:center; z-index:3000}
    .vmodal.show{display:grid}
    .vwrap{position:relative; width:min(1280px,96vw)}
    .vwrap video{width:100%; height:auto; border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.6)}
    .vwrap iframe{width:100%; aspect-ratio:16/9; border:0; border-radius:14px; box-shadow:0 20px 60px rgba(0,0,0,.6)}
    .vclose{position:absolute; top:-44px; right:0}

    /* Finish notice (after gifts) */
    .end{position:fixed; inset:0; display:none; place-items:center; background:rgba(3,6,18,.92); z-index:2600}
    .end.show{display:grid}
    .end-card{
      width:min(760px,94vw); text-align:center; padding:28px; border-radius:24px;
      background:
        radial-gradient(800px 400px at 50% -10%, rgba(255,220,115,.35), transparent 60%),
        linear-gradient(180deg,#1f2f6b,#0b173f);
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 40px 120px rgba(0,0,0,.6)
    }
    .end-title{margin:0 0 10px; font-size:clamp(28px,5vw,44px); color:var(--gold); font-weight:900}
    .end-text{font-weight:800; color:var(--ink); opacity:.95; margin-bottom:16px}
    .end-btn{font-size:20px; padding:16px 24px; border-radius:16px}

    /* ===== Countdown GATE (overlay) ===== */
    .gate{
      position:fixed; inset:0; z-index:5000;
      display:none; place-items:center;
      background:radial-gradient(1200px 600px at 50% -10%, rgba(255,220,115,.15), transparent 65%), rgba(2,6,18,.94);
      backdrop-filter:saturate(1.1) blur(2px);
    }
    .gate.show{display:grid}
    .gcard{
      width:min(1100px,96vw); text-align:center; padding:32px 24px; border-radius:28px;
      background:linear-gradient(180deg,#132a63,#0b173f);
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 50px 160px rgba(0,0,0,.65)
    }
    .gtitle{margin:0 0 10px; font-size:clamp(26px,4.5vw,38px); color:var(--gold); font-weight:900; letter-spacing:.4px}
    .gsub{margin:0 0 18px; color:var(--muted); font-weight:800}
    .clock{
      display:flex; justify-content:center; gap:min(24px,3vw); flex-wrap:wrap;
      margin:10px 0 4px;
    }
    .tick{
      min-width:150px; padding:14px 16px; border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.14);
      box-shadow:inset 0 0 40px rgba(0,0,0,.25), 0 16px 40px rgba(0,0,0,.35);
    }
    .num{
      font-weight:900; line-height:1; letter-spacing:1px;
      font-size:clamp(40px, 10vw, 110px);
      color:var(--gold);
      text-shadow:0 2px 0 #000, 0 18px 40px rgba(0,0,0,.35);
    }
    .lbl{opacity:.9; font-weight:800; margin-top:6px}
    .gfoot{margin-top:14px; font-size:13px; color:var(--muted)}
    .gfoot b{color:var(--gold)}
  </style>
</head>
<body>
  <!-- Intro -->
  <div id="intro" class="intro">
    <div class="ibox">
      <h3>üéôÔ∏è –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–∞—à–µ–≥–æ —É–≤–∞–∂–∞–µ–º–æ–≥–æ –≥–æ—Å—Ç—è</h3>
      <div id="introText" class="itype"></div>
      <div class="icta">
        <button id="introPlay" class="btn">‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏</button>
        <button id="introClose" class="btn btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="veil">
    <div class="wrap">
      <div class="bar">
        <div>
          <div class="title">–ü–û–õ–ï –ß–£–î–ï–° ‚Äî –Æ–±–∏–ª–µ–π–Ω–æ–µ —à–æ—É</div>
          <div class="sub">–ö—Ä—É—Ç–∏ –±–∞—Ä–∞–±–∞–Ω, –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, –±—É–¥—å —Å—á–∞—Å—Ç–ª–∏–≤!</div>
        </div>
        <div class="bar">
          <button id="reset" class="btn btn-ghost">–°–±—Ä–æ—Å</button>
        </div>
      </div>

      <!-- Top panel -->
      <div class="card pad panel" id="panel">
        <div class="rule" id="rule">–ü—Ä–∞–≤–∏–ª–∞: –Ω–∞–∂–º–∏ ¬´–ö—Ä—É—Ç–∏—Ç—å¬ª, –¥–æ–∂–¥–∏—Å—å –æ—á–∫–æ–≤ –∏ –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å.</div>
        <div>–°—á—ë—Ç: <span id="score" class="points">0</span></div>
      </div>

      <div class="grid">
        <!-- Left: Wheel -->
        <div class="card pad">
          <div class="wheel-wrap">
            <div class="pin"></div>
            <canvas id="wheel"></canvas>
            <div class="cap"><button id="spin" class="btn">üé° –ö—Ä—É—Ç–∏—Ç—å</button></div>
          </div>
          <div class="log" id="log"></div>
        </div>

        <!-- Right: Question / Answer -->
        <div class="card pad qbox">
          <div class="q" id="question">–í–æ–ø—Ä–æ—Å –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –±–∞—Ä–∞–±–∞–Ω–∞.</div>
          <div class="word-len" id="length"></div>
          <div class="answer" id="answerBox">
            <input id="answer" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ" />
            <button id="submit" class="btn">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
          </div>
          <div class="note">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—Å—è <span style="color:var(--good)">–∑–µ–ª—ë–Ω—ã–º</span>, –Ω–µ–≤–µ—Ä–Ω—ã–π ‚Äî <span style="color:var(--bad)">–∫—Ä–∞—Å–Ω—ã–º</span>.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Q modal -->
  <div id="qModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3 class="modal-title" id="qTitle">–¢–≤–æ–∏ –±–∞–ª–ª—ã</h3>
      <div id="qScore" class="modal-text bigScore"></div>
      <div id="qText" class="modal-text"></div>
      <button id="qClose" class="btn">–ô–û–£</button>
    </div>
  </div>

  <!-- Fullscreen MP4 video (–ø–æ—Å–ª–µ —Å—É–ø–µ—Ä-–∏–≥—Ä—ã) -->
  <div id="videoModal" class="vmodal" aria-hidden="true">
    <div class="vwrap">
      <button id="videoClose" class="btn vclose">–ó–∞–∫—Ä—ã—Ç—å ‚úñ</button>
      <video id="finalVideo" src="dreamina.mp4" controls></video>
    </div>
  </div>

  <!-- Fullscreen YouTube (—Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–¥–∞—Ä–∫–æ–≤) -->
  <div id="ytModal" class="vmodal" aria-hidden="true">
    <div class="vwrap">
      <button id="ytClose" class="btn vclose">–ó–∞–∫—Ä—ã—Ç—å ‚úñ</button>
      <iframe id="ytFrame" title="–ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ" allow="autoplay; encrypted-media" allowfullscreen></iframe>
    </div>
  </div>

  <!-- Gifts -->
  <div id="finalModal" class="final" aria-hidden="true">
    <div class="final-card">
      <h3 class="final-title">üèÜ –í—ã–±–æ—Ä –ø–æ–¥–∞—Ä–∫–æ–≤</h3>
      <p id="finalIntro" class="sub"></p>
      <div class="pill">–ë—é–¥–∂–µ—Ç: <b id="budget"></b> –æ—á–∫–æ–≤ ‚Ä¢ –í—ã–±—Ä–∞–Ω–æ: <b id="spent">0</b></div>

      <div id="giftList" class="gift-grid"></div>

      <div class="final-bar">
        <div>
          <div id="finalWarn" class="warn"></div>
          <div id="notifyStatus" class="sub"></div>
        </div>
        <div style="display:flex; gap:8px">
          <button id="clearGifts" class="btn btn-ghost">–°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä</button>
          <button id="confirmGifts" class="btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä</button>
          <button id="closeFinal" class="btn btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bright finish notice -->
  <div id="endModal" class="end" aria-hidden="true">
    <div class="end-card">
      <h3 class="end-title">üéÅ –ü–æ–¥–∞—Ä–æ–∫ –æ—Ç –º–∞–º—ã –∏ –±—Ä–∞—Ç–∞ —É–∂–µ –≤ –ø—É—Ç–∏!</h3>
      <div class="end-text">–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–≥—Ä—É! –û—Å—Ç–∞–ª—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–π —à—Ç—Ä–∏—Ö ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ.</div>
      <button id="endFinish" class="btn end-btn">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É</button>
    </div>
  </div>

  <!-- ===== Countdown overlay (GATE) ===== -->
  <div id="gate" class="gate" aria-hidden="true">
    <div class="gcard">
      <h3 class="gtitle">üîí –î–æ—Å—Ç—É–ø –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã—Ç –≤ —Å—É–±–±–æ—Ç—É</h3>
      <p class="gsub">–û—Å—Ç–∞–ª–æ—Å—å –¥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è:</p>
      <div class="clock" id="clock">
        <div class="tick"><div class="num" id="d">00</div><div class="lbl">–¥–Ω–µ–π</div></div>
        <div class="tick"><div class="num" id="h">00</div><div class="lbl">—á–∞—Å–æ–≤</div></div>
        <div class="tick"><div class="num" id="m">00</div><div class="lbl">–º–∏–Ω—É—Ç</div></div>
        <div class="tick"><div class="num" id="s">00</div><div class="lbl">—Å–µ–∫—É–Ω–¥</div></div>
      </div>
      <div class="gfoot">–°–æ–≤—Å–µ–º —Å–∫–æ—Ä–æ –Ω–∞—á–Ω—ë–º. –ï—Å–ª–∏ —Ç—ã –∞–¥–º–∏–Ω ‚Äî –¥–æ–±–∞–≤—å <b>?preview=1</b> –∫ –∞–¥—Ä–µ—Å—É, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–∞–π—Ç.</div>
    </div>
  </div>

  <script>
    // ===== Intro (audio + typewriter)
    const introTextFixed = `–ü—Ä–∏–≤–µ—Ç –ù–∞—Å—Ç—ë–Ω–∞, –í–∞–Ω—è –∏ –¥—Ä—É–≥–∏–µ —É–≤–∞–∂–∞–µ–º—ã–µ –≥–æ—Å—Ç–∏. –ù—É –≤–æ—Ç –∏ –ø—Ä–∏—à—ë–ª —Ç–æ—Ç —Å–∞–º—ã–π –¥–µ–Ω—å, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ —Å—ã–≥—Ä–∞—Ç—å –≤ –∏–≥—Ä—É. –ü—Ä–∞–≤–∏–ª–∞ –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç—ã - –Ω–∞–ª–µ–π—Ç–µ —Å–µ–±–µ —à–∞–º–ø—É—Å–∏–∫–∞ –∏ –ø–æ–ª—É—á–∞–π—Ç–µ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ —Ä–æ–¥–Ω–µ–Ω—å–∫–∏–µ –≤—ã –º–æ–∏`;
    const introAudio = new Audio('intro.mp3');
    const intro = document.getElementById('intro');
    const introPlay = document.getElementById('introPlay');
    const introClose = document.getElementById('introClose');
    const introTextEl = document.getElementById('introText');

    function typewrite(text, el, speed=96){
      return new Promise(res=>{
        el.textContent=''; let i=0;
        const t=setInterval(()=>{ el.textContent += text[i++]||''; if(i>=text.length){ clearInterval(t); res(); } }, speed);
      });
    }
    introPlay.addEventListener('click', async ()=>{
      introPlay.disabled = true;
      try{ await introAudio.play(); }catch(e){}
      await typewrite(introTextFixed, introTextEl);
    });
    introClose.addEventListener('click', ()=>{ intro.classList.add('hide'); try{ introAudio.pause(); }catch(e){} });

    // ===== Sounds
    const spinSong = new Audio('song.mp3'); spinSong.loop = true; spinSong.preload = 'auto'; spinSong.volume = 0.3;
    const wrongSfx = new Audio('pole_letter_wrong.mp3');
    const winSfx1  = new Audio('zrejdbxx.mp3');
    const winSfx2  = new Audio('pole_word_1996.mp3');

    // ===== Wheel
    const points = [100,200,300,400,500,600,700,800,900,1000];
    const wheel  = document.getElementById('wheel');
    const ctx    = wheel.getContext('2d');
    let angle=0, spinning=false;

    function drawWheel(a=0){
      const W = wheel.width  = wheel.clientWidth  * devicePixelRatio;
      const H = wheel.height = wheel.clientHeight * devicePixelRatio;
      const cx=W/2, cy=H/2; const R=Math.min(W,H)/2 - 12*devicePixelRatio;
      const n = points.length; const arc = 2*Math.PI/n;
      ctx.clearRect(0,0,W,H); ctx.save(); ctx.translate(cx,cy); ctx.rotate(a);

      for(let i=0;i<n;i++){
        ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,R,i*arc,(i+1)*arc);
        ctx.fillStyle = (i%2? '#103079':'#142d63'); ctx.fill();
        ctx.strokeStyle = '#0a1e4f'; ctx.lineWidth = 3*devicePixelRatio; ctx.stroke();
        ctx.save(); ctx.rotate(i*arc + arc/2); ctx.fillStyle = '#ffdc73';
        ctx.font = `${Math.max(18*devicePixelRatio,R*0.085)}px system-ui`;
        ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.translate(R*0.75,0); ctx.rotate(Math.PI/2);
        ctx.fillText(points[i].toString(),0,0);
        ctx.restore();
      }
      const bulbs = 72;
      for(let i=0;i<bulbs;i++){
        const ang = a + (i/bulbs)*Math.PI*2;
        const bx = Math.cos(ang)*(R+10*devicePixelRatio);
        const by = Math.sin(ang)*(R+10*devicePixelRatio);
        ctx.beginPath(); ctx.arc(bx,by,4*devicePixelRatio,0,Math.PI*2);
        const on = (Math.floor(Date.now()/120)%2===i%2);
        ctx.fillStyle = on? 'rgba(255,240,150,.95)':'rgba(255,210,77,.85)';
        ctx.fill(); ctx.strokeStyle='rgba(0,0,0,.45)'; ctx.stroke();
      }
      ctx.restore();
    }
    window.addEventListener('resize', ()=> drawWheel(angle));
    drawWheel(angle);

    // ==== spin(): –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è ¬´—Å–∏–ª–∞¬ª + —Å–ª—É—á–∞–π–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 8‚Äì15 —Å–µ–∫
    function spin(){
      if(spinning) return;
      spinning = true;
      try{ spinSong.volume = 1.0; if (spinSong.paused) spinSong.play(); }catch(e){}

      const DURATION = Math.floor(8000 + Math.random()*7000); // 8‚Äì15 —Å–µ–∫
      const TURNS    = 7;                                     // —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è ¬´—Å–∏–ª–∞¬ª

      const startAngle = angle;
      const n = points.length; const arc = 2*Math.PI/n;

      const targetIndex = Math.floor(Math.random()*n);
      const sectorCenter = (targetIndex + 0.5) * arc;
      const targetAngle  = -Math.PI/2 - sectorCenter;
      const endAngle     = targetAngle + TURNS*2*Math.PI;

      const easeOutCubic = t => 1 - Math.pow(1 - t, 3);
      const t0 = performance.now();

      function step(ts){
        const t = Math.min(1, (ts - t0) / DURATION);
        const eased = easeOutCubic(t);
        angle = startAngle + (endAngle - startAngle) * eased;
        drawWheel(angle);
        if(t < 1) requestAnimationFrame(step); else { spinning=false; finalize(targetIndex); }
      }
      requestAnimationFrame(step);
    }
    document.getElementById('spin').addEventListener('click', spin);

    function finalize(idx){
      try{ spinSong.volume = 0.3; if (spinSong.paused) spinSong.play(); }catch(e){}
      const p = points[idx];
      log(`üéØ –í—ã–ø–∞–ª–æ: <b>${p}</b> –æ—á–∫–æ–≤`);

      if(superSpinPending){
        document.getElementById('qTitle').textContent = '–°–£–ü–ï–† –ò–ì–†–ê';
        document.getElementById('qScore').textContent = '';
        document.getElementById('qText').innerHTML = '–û—á–∫–∏ —É–¥–≤–∞–∏–≤–∞—é—Ç—Å—è!<br>–í–æ–ø—Ä–æ—Å: ¬´–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π –¥–∏–ø–ª–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥–∞—Ä–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–Ω–∏–º–∞—é—Ç –±–µ–∑ –≤–∏–∑—ã. –ß—Ç–æ —ç—Ç–æ?¬ª';
        qModal.classList.add('show'); qModal.setAttribute('aria-hidden','false');
        superRoundActive = true;
        document.getElementById('rule').textContent = '–û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å –°–£–ü–ï–† –ò–ì–†–´!';
        document.getElementById('question').textContent = '–°–£–ü–ï–† –ò–ì–†–ê ‚Äî –≤–æ–ø—Ä–æ—Å —É–∂–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ.';
        document.getElementById('length').textContent = '–°–ª–æ–≤–æ –∏–∑ 6 –±—É–∫–≤';
        const input = document.getElementById('answer'); input.value=''; input.focus();
        document.getElementById('answerBox').classList.remove('correct','wrong');
        return;
      }

      document.getElementById('rule').innerHTML = `–¢–≤–æ–∏ –æ—á–∫–∏ –∑–∞ –±–∞—Ä–∞–±–∞–Ω: <span class="points">${p}</span>. –û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å!`;

      const r = normalRounds[round];
      setTimeout(()=>{
        document.getElementById('qTitle').textContent = '–¢–≤–æ–∏ –±–∞–ª–ª—ã';
        document.getElementById('qScore').textContent = `${p}`;
        document.getElementById('qText').textContent  = `–¢–≤–æ–π –≤–æ–ø—Ä–æ—Å: "${r ? r.q : ''}"`;
        qModal.classList.add('show'); qModal.setAttribute('aria-hidden','false');
      }, 1200);

      showQuestion(p);
    }

    function log(html){
      const box=document.getElementById('log');
      const d=document.createElement('div');
      d.innerHTML = `<span class="note">${new Date().toLocaleTimeString()}</span> ${html}`;
      box.prepend(d);
    }

    // ===== Questions (–æ–±–Ω–æ–≤–ª–µ–Ω–æ)
    const normalRounds = [
      { q: '–ß—É—Ç—å –Ω–µ —Å–≥–æ—Ä–µ–ª–∏ –º—ã –≤ –∫–æ—Å—Ç—Ä–µ, –≤–º–µ—Å—Ç–æ –≤–æ–¥—ã –≤ –Ω–∞—Å –∫–æ–Ω—å—è—á–æ–∫, –º—ã —Ç–∞–Ω—Ü–µ–≤–∞–ª–∏ –¥–æ —É—Ç—Ä–∞, –≤ —Å–∞—Ä–∞–µ —è —É–ª–µ–≥—Å—è –Ω–∞ –±–æ—á–æ–∫', a: ['–ö–£–ü–ê–õ–ê','–ö–£–ü–ê–õ–û'] },
      { q: '–£—É–£—É–£—É ¬´–í–æ—Å—å–º–∏–∫–ª–∞—Å—Å–Ω–∏—Ü–∞¬ª. –ì–¥–µ –∏—Å–ø–æ–ª–Ω—è–ª–∞—Å—å —ç—Ç–∞ –∫–æ–º–ø–æ–∑–∏—Ü–∏—è?', a: '–ó–´–ë–ê' },
      { q: '–û–Ω–∏ —É–º–µ–ª–∏ –ª–µ—Ç–∞—Ç—å, —Å–∞–º—ã–µ –±–æ–≥–∞—Ç—ã–µ –∫–ª–∞–ª–∏ –ø–æ–¥ –∂–æ–ø—É –ø–ª–∞—Å—Ç–∏–∫, –º—ã –∂–µ –∫–∞–∫ –∫–∏–ª—å–∫–∞ –≤ –±–∞–Ω–∫–µ –ª–µ–∂–∞–ª–∏ –Ω–∞ –∫–ª–µ—ë–Ω–∫–µ, –∏—Ç–æ–≥ –±—ã–ª –æ–¥–∏–Ω ‚Äî –ò–ò–ò–ò—É—É—É –∏ –º–æ–∫—Ä–∞—è –∂–æ–ø–∞', a: '–ì–û–†–ö–ê' },
      { q: '–°–µ–π—á–∞—Å –ª—é–¥–∏ –≥–æ–ª–æ—Å—É—é—Ç –Ω–∞ —á–µ—Å—Ç–Ω—ã—Ö –≤—ã–±–æ—Ä–∞—Ö. –†–∞–Ω—å—à–µ –∂–µ –≥–æ–ª–æ—Å–∞ –º–æ–∂–Ω–æ –±—ã–ª–æ –∫—É–ø–∏—Ç—å —Å –ø–æ–º–æ—â—å—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Å —Å–∏–≥–º–æ–π. –ö—Ç–æ —ç—Ç–æ—Ç –¥–æ–±—Ä—ã–π —Å–∞–º–∞—Ä–∏—Ç—è–Ω–∏–Ω?', a: '–ö–£–ö–õ–Æ–ö' },
      { q: '–°—Ç–æ–∏–ª–æ –∫–æ–º—É-—Ç–æ –≤—ã–Ω–µ—Å—Ç–∏ –µ–≥–æ –∏–∑ —Å—Ç–æ–ª–æ–≤–æ–π ‚Äî —Å—Ä–∞–∑—É –ø–æ—è–≤–ª—è–ª–æ—Å—å –ø—è—Ç—å ¬´–¥—Ä—É–∑–µ–π¬ª, –∫–æ—Ç–æ—Ä—ã—Ö –¥–æ —ç—Ç–æ–≥–æ —Ç—ã –Ω–µ –∑–Ω–∞–ª.', a: ['–ë–ï–õ–Ø–®','–ë–ò–õ–Ø–®'] },
      { q: '–≠—Ç–æ –Ω–µ —É—Ä–æ–∫ –±–∏–æ–ª–æ–≥–∏–∏, –Ω–æ —Ç–∞–º –º—ã –≤–ø–µ—Ä–≤—ã–µ –∏–∑—É—á–∞–ª–∏ ¬´–∞–Ω–∞—Ç–æ–º–∏—é¬ª –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ. –≠—Ç–æ –Ω–µ –∫—É–∫—É—Ä—É–∑–Ω–æ–µ –ø–æ–ª–µ, –Ω–æ —Ç–∞–º –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–ø—Ä—è—Ç–∞—Ç—å—Å—è. –≠—Ç–æ –Ω–µ —Å–µ–∫—Ü–∏—è –±–æ—Ä—å–±—ã, –Ω–æ —Ç–∞–º —á–∞—Å—Ç–æ –æ–∫–∞–∑—ã–≤–∞–ª–∏—Å—å –≤ —Å—Ç—Ä–∞–Ω–Ω—ã—Ö –∑–∞—Ö–≤–∞—Ç–∞—Ö. –≠—Ç–æ –Ω–µ –¥–æ–ø—Ä–æ—Å–Ω–∞—è, –Ω–æ —Å—Ç–æ–∏–ª–æ –≤–∫–ª—é—á–∏—Ç—å —Ñ–æ–Ω–∞—Ä—å ‚Äî –∫—Ç–æ-—Ç–æ —Å—Ä–∞–∑—É –ø—Ä–∏–∑–Ω–∞–≤–∞–ª—Å—è –∏ –Ω–∞—á–∏–Ω–∞–ª —Å—Å–∞—Ç—å.', a: '–°–ê–†–ê–ô' },
      { q: '–ì–¥–µ –º–æ–∂–Ω–æ –±—ã–ª–æ –∏—Å–∫—É–ø–∞—Ç—å—Å—è, –≤—ã–π—Ç–∏ ¬´—Å–≤–µ–∂–∏–º¬ª, –∞ –ø–æ—Ç–æ–º –≤–æ–Ω—è—Ç—å –±–æ–ª–æ—Ç–æ–º —Ç—Ä–∏ –¥–Ω—è –ø–æ–¥—Ä—è–¥?', a: ['–ö–ê–ú–ï–ù–ö–ê','–ü–†–ò–õ–ï–ü–´'] }
    ];
    const superQuestion = { q: '–ë–µ–ª–æ—Ä—É—Å—Å–∫–∏–π –¥–∏–ø–ª–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥–∞—Ä–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–Ω–∏–º–∞—é—Ç –±–µ–∑ –≤–∏–∑—ã. –ß—Ç–æ —ç—Ç–æ?', a: ['–ë–£–õ–¨–ë–ê'] };

    let round = 0; let score = 0;
    let currentSpinPoints = 0;
    let superSpinPending = false;
    let superRoundActive = false;

    function normalizeRu(s){ return s.trim().toUpperCase().replace(/–Å/g,'–ï'); }
    function getAcceptList(a){ return Array.isArray(a) ? a.map(normalizeRu) : [normalizeRu(a)]; }

    function showQuestion(p=0){
      currentSpinPoints = p;
      const r = normalRounds[round];
      if(!r){
        superSpinPending = true;
        document.getElementById('rule').textContent = '–§–∏–Ω–∞–ª! –ö—Ä—É—Ç–∏ –±–∞—Ä–∞–±–∞–Ω –¥–ª—è –°–£–ü–ï–† –ò–ì–†–´.';
        document.getElementById('question').textContent = '–°–£–ü–ï–† –ò–ì–†–ê –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–∞—Ä–∞–±–∞–Ω–∞.';
        document.getElementById('length').textContent  = '';
        return;
      }
      document.getElementById('question').textContent = `–í–æ–ø—Ä–æ—Å: ${r.q}`;
      const firstAns = Array.isArray(r.a) ? r.a[0] : r.a;
      document.getElementById('length').textContent  = `–°–ª–æ–≤–æ –∏–∑ ${normalizeRu(firstAns).length} –±—É–∫–≤`;
      const input = document.getElementById('answer'); input.value=''; input.focus();
      document.getElementById('answerBox').classList.remove('correct','wrong');
    }

    function checkAnswer(){
      const box  = document.getElementById('answerBox');
      const got  = normalizeRu(document.getElementById('answer').value);

      if(superRoundActive){
        const list = getAcceptList(superQuestion.a);
        if(list.includes(got)){
          box.classList.remove('wrong'); box.classList.add('correct');
          log('‚úÖ –°–£–ü–ï–†! –û—Ç–≤–µ—Ç –≤–µ—Ä–Ω—ã–π, –æ—á–∫–∏ —É–¥–≤–∞–∏–≤–∞—é—Ç—Å—è.');
          score = score * 2;
          document.getElementById('score').textContent = score;
          launchConfetti();
          try{ (Math.random()<0.5 ? winSfx1 : winSfx2).play(); }catch(e){}
          superRoundActive = false;
          superSpinPending = false;
          setTimeout(()=> endGameWithVideo(), 3000);
        } else {
          box.classList.remove('correct'); box.classList.add('wrong');
          log('‚ùå –≠—Ö—Ö, –≤—ã —Å–æ–≤–µ—Ä—à–∏–ª–∏ –æ—à–∏–±–∫—É. –£–¥–≤–∞–∏–≤–∞–Ω–∏–µ –æ—á–∫–æ–≤ –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
          try{ wrongSfx.currentTime=0; wrongSfx.play(); }catch(e){}
        }
        return;
      }

      const r = normalRounds[round]; if(!r) return;
      const list = getAcceptList(r.a);

      if(list.includes(got)){
        box.classList.remove('wrong'); box.classList.add('correct');
        if(!isNaN(currentSpinPoints)){ score += currentSpinPoints; document.getElementById('score').textContent = score; }
        log('‚úÖ –°–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –≤–µ—Ä–Ω–æ!');
        launchConfetti();
        try{ (Math.random()<0.5 ? winSfx1 : winSfx2).play(); }catch(e){}

        round++;
        setTimeout(()=>{
          if(round >= normalRounds.length){
            document.getElementById('rule').textContent = '–§–∏–Ω–∞–ª! –ö—Ä—É—Ç–∏ –±–∞—Ä–∞–±–∞–Ω –¥–ª—è –°–£–ü–ï–† –ò–ì–†–´.';
            document.getElementById('question').textContent = '–°–£–ü–ï–† –ò–ì–†–ê –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–∞—Ä–∞–±–∞–Ω–∞.';
            document.getElementById('length').textContent  = '';
            superSpinPending = true;
          } else {
            document.getElementById('rule').textContent = '–°–Ω–æ–≤–∞ –∫—Ä—É—Ç–∏ –±–∞—Ä–∞–±–∞–Ω!';
            document.getElementById('question').textContent = '–í–æ–ø—Ä–æ—Å –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –±–∞—Ä–∞–±–∞–Ω–∞.';
            document.getElementById('length').textContent = '';
          }
        }, 500);
      } else {
        box.classList.remove('correct'); box.classList.add('wrong');
        log('‚ùå –ù–µ–≤–µ—Ä–Ω–æ, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.');
        try{ wrongSfx.currentTime=0; wrongSfx.play(); }catch(e){}
      }
    }
    document.getElementById('submit').addEventListener('click', checkAnswer);
    document.getElementById('answer').addEventListener('keydown', e=>{ if(e.key==='Enter') checkAnswer(); });

    // Q modal controls
    const qModal = document.getElementById('qModal');
    document.getElementById('qClose').addEventListener('click',()=>{
      qModal.classList.remove('show');
      qModal.setAttribute('aria-hidden','true');
      document.getElementById('answer').focus();
    });

    document.getElementById('reset').addEventListener('click', ()=>{
      try{ spinSong.pause(); }catch(e){}
      spinSong.currentTime=0; spinSong.volume=0.3;
      score=0; round=0; angle=0;
      superSpinPending=false; superRoundActive=false; currentSpinPoints=0;
      document.getElementById('score').textContent='0';
      document.getElementById('rule').textContent='–ü—Ä–∞–≤–∏–ª–∞: –Ω–∞–∂–º–∏ ¬´–ö—Ä—É—Ç–∏—Ç—å¬ª, –¥–æ–∂–¥–∏—Å—å –æ—á–∫–æ–≤ –∏ –æ—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å.';
      document.getElementById('question').textContent='–í–æ–ø—Ä–æ—Å –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –±–∞—Ä–∞–±–∞–Ω–∞.';
      document.getElementById('length').textContent='';
      qModal.classList.remove('show'); qModal.setAttribute('aria-hidden','true');
      document.getElementById('finalModal').classList.remove('show'); document.getElementById('finalModal').setAttribute('aria-hidden','true');
      document.getElementById('videoModal').classList.remove('show'); document.getElementById('videoModal').setAttribute('aria-hidden','true');
      document.getElementById('ytModal').classList.remove('show'); document.getElementById('ytModal').setAttribute('aria-hidden','true');
      drawWheel(0); document.getElementById('log').innerHTML='';
    });

    // ===== Confetti
    function launchConfetti(){
      const c=document.createElement('canvas'); c.className='confetti'; document.body.appendChild(c);
      const cx=c.getContext('2d'); const DPR=window.devicePixelRatio||1;
      let W=innerWidth, H=innerHeight; c.width=W*DPR; c.height=H*DPR; cx.scale(DPR,DPR);
      const parts=[...Array(140)].map(()=>({
        x:Math.random()*W, y:-20-Math.random()*H*0.3,
        vx:-2+Math.random()*4, vy:2+Math.random()*4,
        rot:Math.random()*Math.PI, vr:-0.2+Math.random()*0.4,
        life:120+Math.random()*80, size:5+Math.random()*5,
        hue:Math.random()*360
      }));
      function draw(){
        cx.clearRect(0,0,W,H);
        parts.forEach(p=>{
          p.x+=p.vx; p.y+=p.vy; p.rot+=p.vr; p.life--;
          cx.save(); cx.translate(p.x,p.y); cx.rotate(p.rot);
          cx.fillStyle=`hsl(${p.hue},85%,60%)`;
          cx.fillRect(-p.size/2,-p.size/2,p.size,p.size);
          cx.restore();
        });
        if(parts.some(p=>p.life>0)) requestAnimationFrame(draw); else c.remove();
      }
      draw();
    }

    // ===== Final video (–ø–æ—Å–ª–µ —Å—É–ø–µ—Ä-–∏–≥—Ä—ã)
    const videoModal = document.getElementById('videoModal');
    const finalVideo = document.getElementById('finalVideo');
    const videoClose = document.getElementById('videoClose');

    function endGameWithVideo(){
      setTimeout(()=>{
        try{ spinSong.pause(); }catch(e){}
        videoModal.classList.add('show'); videoModal.setAttribute('aria-hidden','false');
        try{ finalVideo.currentTime = 0; finalVideo.play(); }catch(e){}
      }, 0);
    }
    function closeVideoAndOpenGifts(){
      try{ finalVideo.pause(); }catch(e){}
      videoModal.classList.remove('show'); videoModal.setAttribute('aria-hidden','true');
      openGifts(score);
    }
    videoClose.addEventListener('click', closeVideoAndOpenGifts);

    // ===== YouTube final (–ø–æ—Å–ª–µ –ø–æ–¥–∞—Ä–∫–æ–≤)
    const ytModal = document.getElementById('ytModal');
    const ytFrame = document.getElementById('ytFrame');
    const ytClose = document.getElementById('ytClose');

    function openFinalCongratsVideo(){
      try{ spinSong.pause(); }catch(e){}
      ytFrame.src = 'https://www.youtube.com/embed/V41i42fp4dU?autoplay=1&rel=0&modestbranding=1';
      ytModal.classList.add('show'); ytModal.setAttribute('aria-hidden','false');
    }
    ytClose.addEventListener('click', ()=>{
      ytFrame.src = '';
      ytModal.classList.remove('show'); ytModal.setAttribute('aria-hidden','true');
    });

    // ===== Gifts
    const giftsSource = [
      {name:'–ì–æ—Ä–Ω—ã–π –≤–µ–ª–æ—Å–∏–ø–µ–¥', tier:'4/4', desc:'–°–æ–≥–ª–∞—Å–æ–≤—ã–≤–∞–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ'},
      {name:'–ü—Ä—ã–∂–æ–∫ —Å –ø–∞—Ä–∞—à—é—Ç–æ–º –≤ –ª—é–±–æ–π —Ç–æ—á–∫–µ –º–∏—Ä–∞', tier:'4/4', desc:'–ö—É–ø–æ–Ω –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏'},
      {name:'–í–∞–π–±–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ Marshall', tier:'4/4', link:'https://catalog.onliner.by/wspeaker/marshall/acton2bl1'},
      {name:'E-book Amazon –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è', tier:'4/4', link:'https://kindle.by/devices/amazon-kindle-paperwhite-6-12-generation-16gb-black'},
      {name:'–ê–ª–∏—Å–∏–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ (AI edition)', tier:'2/4', link:'https://catalog.onliner.by/wspeaker/yandex/yanstmidiblk'},
      {name:'–ü—Ä–µ–º–∏—É–º –Ω–∞—É—à–Ω–∏–∫–∏ Realme', tier:'2/4', link:'https://market.yandex.ru/card/naushniki-besprovodnyye-realme-buds-air7air7-pro-bluetooth-c-shumopodavleniyem/4598149761'},
      {name:'–°–∫–∏–¥–∫–∞ 30% –Ω–∞ –∞–≤–∏–∞–±–∏–ª–µ—Ç', tier:'2/4', desc:'–ü—Ä–∏–¥—ë—Ç –≤ –≤–∏–¥–µ USDT'},
      {name:'–û—Ç–¥—ã—Ö –≤ –±–∞–Ω—å–∫–µ ¬´–ò–∑–±—É—à–∫–∞¬ª', tier:'2/4', link:'https://www.saunaminska.by/izbushka.htm'},
      {name:'–ü–æ–µ–∑–¥–∫–∞ –≤ –Ω–∞—Ü–ø–∞—Ä–∫ –ù–∞—Ä–æ—á–∞–Ω—ã', tier:'2/4', desc:'–û—Ä–≥–∞–Ω–∏–∑—É–µ–º!'},
      {name:'–û—á–∫–∏ —Å –∫–∞–º–µ—Ä–æ–π 4K Indigo', tier:'2/4', link:'https://catalog.onliner.by/actioncamera/xtry/xtg113fhdindigop'},
      {name:'–ê—ç—Ä–æ–≥—Ä–∏–ª—å BR2039', tier:'1/4', link:'https://brayer.ru/catalog/aerogrili/aerogril-brayer-br2039/'},
      {name:'–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∞—è —â—ë—Ç–∫–∞ Oclean', tier:'1/4', link:'https://catalog.onliner.by/toothbrush/oclean/oclexproelitegre'},
      {name:'–ö–æ–ª—å—Ü–æ –¥–ª—è —Å–Ω–∞ Mijia', tier:'1/4', link:'https://market.yandex.ru/card/xiaomi-smart-ring-bluetooth-black-size-11/4589470934'}
    ];

    const finalModal = document.getElementById('finalModal');
    const giftListEl = document.getElementById('giftList');
    const spentEl = document.getElementById('spent');
    const budgetEl = document.getElementById('budget');
    const finalWarn = document.getElementById('finalWarn');
    const finalIntro = document.getElementById('finalIntro');
    const btnConfirm = document.getElementById('confirmGifts');
    const btnClear = document.getElementById('clearGifts');
    const btnClose = document.getElementById('closeFinal');

    let budget=0, selection={}, pricedGifts=[];

    function roundTo100(x){ return Math.max(100, Math.round(x/100)*100); }
    function randRange(min,max){ return Math.random()*(max-min)+min; }

    function priceByTier(tier, total){
      if(tier==='4/4') return roundTo100(randRange(total*0.90, total*1.00));
      if(tier==='2/4') return roundTo100(randRange(total*0.40, total*0.48));
      return roundTo100(randRange(total*0.20, total*0.25)); // 1/4
    }

    function openGifts(finalScore){
      budget = finalScore;
      budgetEl.textContent = budget.toString();
      spentEl.textContent = '0';
      finalWarn.textContent = '';
      document.getElementById('notifyStatus').textContent = '';
      finalIntro.textContent = `–ò—Ç–æ–≥–æ–≤—ã–π —Å—á—ë—Ç ‚Äî ${finalScore} –æ—á–∫–æ–≤. –í—ã–±–∏—Ä–∞–π –ø—Ä–∏–∑—ã –Ω–∞ —ç—Ç—É —Å—É–º–º—É:`;

      pricedGifts = giftsSource.map(g=> ({...g, price: priceByTier(g.tier, budget)}));

      giftListEl.innerHTML = '';
      selection = {};
      pricedGifts.forEach((g,idx)=>{
        const row = document.createElement('div');
        row.className = 'gift-row';

        const label = document.createElement('label');
        const cb = document.createElement('input');
        cb.type='checkbox'; cb.dataset.idx = idx;
        label.appendChild(cb);

        const text = document.createElement('div');
        const name = document.createElement('div');
        const more = g.link ? ` ‚Äî <a href="${g.link}" target="_blank" rel="noopener">—É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ</a>`
                            : (g.desc ? ` ‚Äî <span class="sub">${g.desc}</span>` : '');
        name.innerHTML = `${g.name} ‚Äî <b>${g.price}</b> –æ—á–∫–æ–≤${more}`;
        text.appendChild(name);

        row.appendChild(label);
        row.appendChild(text);
        giftListEl.appendChild(row);

        cb.addEventListener('change', onSelectChange);
      });

      btnConfirm.onclick = confirmGifts;
      btnClear.onclick = clearSelection;
      btnClose.onclick = ()=>closeGifts();

      finalModal.classList.add('show'); finalModal.setAttribute('aria-hidden','false');
    }

    function closeGifts(){
      finalModal.classList.remove('show');
      finalModal.setAttribute('aria-hidden','true');
    }

    function onSelectChange(e){
      const idx = parseInt(e.target.dataset.idx,10);
      selection[idx] = e.target.checked;
      recompute();
    }

    function recompute(){
      let spent = 0;
      Object.entries(selection).forEach(([k,v])=>{
        if(!v) return;
        spent += pricedGifts[parseInt(k,10)].price;
      });

      spentEl.textContent = spent.toString();
      let warn = '';
      if(spent > budget) warn += '–ü–µ—Ä–µ–±–æ—Ä –±—é–¥–∂–µ—Ç–∞. ';
      finalWarn.textContent = warn.trim();
      btnConfirm.disabled = warn.length>0 || spent===0;
    }

    function clearSelection(){
      selection = {};
      document.querySelectorAll('#giftList input[type="checkbox"]').forEach(cb=> cb.checked=false);
      recompute();
    }

    // === Netlify Forms submission (hidden form below)
    function confirmGifts(){
      const chosen = Object.entries(selection)
        .filter(([,v])=>v)
        .map(([k])=> pricedGifts[parseInt(k,10)]);
      if (chosen.length === 0) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–∏–∑.'); return; }

      const names = chosen.map(c=>`${c.name} ‚Äî ${c.price} –æ—á–∫–æ–≤`).join('\n');
      const spent = chosen.reduce((s,c)=>s + c.price, 0);

      const ns = document.getElementById('notifyStatus');
      ns.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è—é –≤—ã–±–æ—Ä...';

      const form = document.forms['gift-submit'];
      form.player_name.value = '–ì–æ—Å—Ç—å';
      form.score.value       = String(score);
      form.spent.value       = String(spent);
      form.chosen.value      = names.replace(/\n/g, ' | ');
      form.timestamp.value   = new Date().toISOString();
      form.ua.value          = navigator.userAgent;

      const data = new FormData(form);
      fetch("/", { method: "POST", body: data })
        .then(()=>{
          ns.textContent = '‚úÖ –í—ã–±–æ—Ä –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (Netlify Forms).';
          alert(`–í—ã–±—Ä–∞–Ω–æ:\n${names}\n\n–°—É–º–º–∞: ${spent} –∏–∑ ${budget}\n\n–°–ø–∞—Å–∏–±–æ!`);
          closeGifts();
          showFinishNotice();
        })
        .catch((err)=>{
          console.error(err);
          ns.textContent = '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ Netlify. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.');
        });
    }

    // ===== Finish notice + YouTube open
    const endModal = document.getElementById('endModal');
    const endFinish = document.getElementById('endFinish');
    function showFinishNotice(){
      endModal.classList.add('show'); endModal.setAttribute('aria-hidden','false');
    }
    endFinish.addEventListener('click', ()=>{
      endModal.classList.remove('show'); endModal.setAttribute('aria-hidden','true');
      openFinalCongratsVideo();
    });

    // ====== COUNTDOWN LOGIC ======
    (function setupGate(){
      const url = new URL(window.location.href);
      const previewBypass = url.searchParams.get('preview') === '1';
      const gate = document.getElementById('gate');
      if(!gate) return;

      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–µ–ª–∏: –±–ª–∏–∂–∞–π—à–∞—è –°–£–ë–ë–û–¢–ê 19:00 –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
      const targetHour = 19, targetMinute = 0;

      function getNextSaturdayAt(h=19, m=0){
        const now = new Date();
        const day = now.getDay(); // 0=Sun ... 6=Sat
        let diff = (6 - day + 7) % 7; // –¥–æ —Å—É–±–±–æ—Ç—ã
        let candidate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff, h, m, 0, 0);
        if (candidate <= now) {
          candidate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diff + 7, h, m, 0, 0);
        }
        return candidate;
      }

      const target = getNextSaturdayAt(targetHour, targetMinute);

      function updateClock(){
        const now = new Date();
        const remain = target - now;
        if (remain <= 0){
          // –í—Ä–µ–º—è –ø—Ä–∏—à–ª–æ ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º –æ–≤–µ—Ä–ª–µ–π
          gate.classList.remove('show');
          gate.setAttribute('aria-hidden','true');
          clearInterval(tid);
          return;
        }
        const s = Math.floor(remain/1000) % 60;
        const m = Math.floor(remain/1000/60) % 60;
        const h = Math.floor(remain/1000/60/60) % 24;
        const d = Math.floor(remain/1000/60/60/24);

        const dd = document.getElementById('d');
        const hh = document.getElementById('h');
        const mm = document.getElementById('m');
        const ss = document.getElementById('s');
        if(dd) dd.textContent = String(d).padStart(2,'0');
        if(hh) hh.textContent = String(h).padStart(2,'0');
        if(mm) mm.textContent = String(m).padStart(2,'0');
        if(ss) ss.textContent = String(s).padStart(2,'0');
      }

      if (previewBypass){
        // –ê–¥–º–∏–Ω-–ø—Ä–æ—Å–º–æ—Ç—Ä ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
        gate.classList.remove('show');
        gate.setAttribute('aria-hidden','true');
        return;
      }

      // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å —Ä–∞–Ω—å—à–µ —Ü–µ–ª–∏ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∏–∫
      if (new Date() < target){
        gate.classList.add('show');
        gate.setAttribute('aria-hidden','false');
        updateClock();
        var tid = setInterval(updateClock, 1000);
      } else {
        gate.classList.remove('show');
        gate.setAttribute('aria-hidden','true');
      }
    })();
  </script>

  <!-- Netlify capture form (hidden, must be in static HTML) -->
  <form name="gift-submit" method="POST" data-netlify="true" netlify style="display:none">
    <input type="hidden" name="form-name" value="gift-submit" />
    <input type="text"   name="player_name" />
    <input type="number" name="score" />
    <input type="number" name="spent" />
    <textarea name="chosen"></textarea>
    <input type="text"   name="timestamp" />
    <input type="text"   name="ua" />
  </form>
</body>
</html>

</body>
</html>
